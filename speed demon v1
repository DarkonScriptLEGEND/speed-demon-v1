local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer
local MAP_BOUNDS = 5000
local BASE_SPEED = 16
local TELEPORT_DISTANCE = 75
local TELEPORT_SPEED_BOOST = 45
local TELEPORT_BOOST_TIME = 1.5
local DETECT_RADIUS = 45
local NEAR_PLAYER_RADIUS = 35
local TELEPORT_SOUND_ID = "rbxassetid://184352058"
local TELEPORT_PARTICLE = "rbxassetid://243098098"
local TELEPORT_COOLDOWN = 0.95

local runAwayEnabled = false
local chaseEnabled = false
local lastTeleport = 0
local char, hrp, humanoid

-- Bind character
local function bindCharacter()
	char = player.Character or player.CharacterAdded:Wait()
	hrp = char:WaitForChild("HumanoidRootPart")
	humanoid = char:WaitForChild("Humanoid")
end
bindCharacter()
player.CharacterAdded:Connect(bindCharacter)

-- UI
local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.ResetOnSpawn = false

local runBtn = Instance.new("TextButton", gui)
runBtn.Size = UDim2.new(0, 150, 0, 40)
runBtn.Position = UDim2.new(0, 10, 0, 10)
runBtn.Text = "Toggle Run Away"
runBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
runBtn.TextColor3 = Color3.new(1, 1, 1)

local chaseBtn = Instance.new("TextButton", gui)
chaseBtn.Size = UDim2.new(0, 150, 0, 40)
chaseBtn.Position = UDim2.new(0, 10, 0, 60)
chaseBtn.Text = "Toggle Chase"
chaseBtn.BackgroundColor3 = Color3.fromRGB(0, 100, 200)
chaseBtn.TextColor3 = Color3.new(1, 1, 1)

-- Teleport FX
local function playTeleportSound()
	local sound = Instance.new("Sound", hrp)
	sound.SoundId = TELEPORT_SOUND_ID
	sound.Volume = 2
	sound:Play()
	Debris:AddItem(sound, 2)
end

local function createTeleportParticles()
	local emitter = Instance.new("ParticleEmitter")
	emitter.Texture = TELEPORT_PARTICLE
	emitter.Lifetime = NumberRange.new(1)
	emitter.Rate = 200
	emitter.Parent = hrp
	Debris:AddItem(emitter, 1)
end

-- Teleport to a safe direction
local function getSafePosition()
	local directions = {
		Vector3.new(1,0,0),
		Vector3.new(-1,0,0),
		Vector3.new(0,0,1),
		Vector3.new(0,0,-1),
		Vector3.new(1,0,1).Unit,
		Vector3.new(-1,0,1).Unit,
		Vector3.new(1,0,-1).Unit,
		Vector3.new(-1,0,-1).Unit,
	}
	local best = hrp.Position
	local maxDist = 0
	for _, dir in ipairs(directions) do
		local pos = hrp.Position + dir * TELEPORT_DISTANCE
		if math.abs(pos.X) <= MAP_BOUNDS and math.abs(pos.Z) <= MAP_BOUNDS and pos.Y > 0 then
			local minDist = math.huge
			for _, p in ipairs(Players:GetPlayers()) do
				if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
					local d = (p.Character.HumanoidRootPart.Position - pos).Magnitude
					if d < minDist then minDist = d end
				end
			end
			if minDist > maxDist then
				maxDist = minDist
				best = pos
			end
		end
	end
	return best
end

local function teleportAway()
	if tick() - lastTeleport < TELEPORT_COOLDOWN then return end
	lastTeleport = tick()
	local dest = getSafePosition()
	hrp.CFrame = CFrame.new(dest)
	playTeleportSound()
	createTeleportParticles()
	humanoid.WalkSpeed = TELEPORT_SPEED_BOOST
	task.delay(TELEPORT_BOOST_TIME, function()
		if humanoid then
			humanoid.WalkSpeed = BASE_SPEED
		end
	end)

	local label = Instance.new("BillboardGui", hrp)
	label.Size = UDim2.new(0, 200, 0, 50)
	label.StudsOffset = Vector3.new(0, 3, 0)
	label.AlwaysOnTop = true
	local txt = Instance.new("TextLabel", label)
	txt.Size = UDim2.new(1, 0, 1, 0)
	txt.BackgroundTransparency = 1
	txt.Text = "Can't Touch This"
	txt.TextColor3 = Color3.new(1, 0, 0)
	txt.TextScaled = true
	Debris:AddItem(label, 5)
end

-- Detect threats
local function detectThreats()
	for _, obj in ipairs(Workspace:GetDescendants()) do
		if obj:IsA("BasePart") or obj:IsA("Script") or obj:IsA("ModuleScript") then
			local d = (obj.Position - hrp.Position).Magnitude
			if d < DETECT_RADIUS then
				teleportAway()
				break
			end
		end
	end
end

-- Get nearest player
local function getNearestPlayer()
	local nearest, dist = nil, math.huge
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
			local d = (hrp.Position - p.Character.HumanoidRootPart.Position).Magnitude
			if d < dist then
				nearest, dist = p, d
			end
		end
	end
	return nearest, dist
end

-- Main loop
RunService.RenderStepped:Connect(function()
	if not hrp or not humanoid then return end
	if runAwayEnabled then
		detectThreats()
		local near, dist = getNearestPlayer()
		if near and dist < NEAR_PLAYER_RADIUS then
			teleportAway()
		else
			if near then
				local dir = (hrp.Position - near.Character.HumanoidRootPart.Position).Unit
				local target = hrp.Position + dir * 10
				humanoid:MoveTo(target)
			end
		end
	elseif chaseEnabled then
		local near, dist = getNearestPlayer()
		if near then
			humanoid:MoveTo(near.Character.HumanoidRootPart.Position)
			if humanoid.WalkSpeed < 22 then
				humanoid.WalkSpeed = 22
			end
		end
	end
end)

-- Button logic
runBtn.MouseButton1Click:Connect(function()
	runAwayEnabled = not runAwayEnabled
	chaseEnabled = false
	runBtn.Text = runAwayEnabled and "Running Away..." or "Toggle Run Away"
	chaseBtn.Text = "Toggle Chase"
end)

chaseBtn.MouseButton1Click:Connect(function()
	chaseEnabled = not chaseEnabled
	runAwayEnabled = false
	chaseBtn.Text = chaseEnabled and "Chasing..." or "Toggle Chase"
	runBtn.Text = "Toggle Run Away"
end)
