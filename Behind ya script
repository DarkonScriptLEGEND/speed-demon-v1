--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Debris = game:GetService("Debris")
local LocalPlayer = Players.LocalPlayer

--// Variables
local Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local Camera = workspace.CurrentCamera
local SpawnTime = tick()
local CanSelfDestruct = false
local RespawnCooldown = 30
local LastTeleportTime = 0

--// Functions
local function getCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

local function isSafePosition(pos)
    local rayOrigin = pos + Vector3.new(0, 10, 0)
    local rayDir = Vector3.new(0, -100, 0)
    local rayParams = RaycastParams.new()
    rayParams.FilterDescendantsInstances = {getCharacter()}
    rayParams.FilterType = Enum.RaycastFilterType.Blacklist

    local result = workspace:Raycast(rayOrigin, rayDir, rayParams)
    return result and result.Instance and result.Instance:IsA("BasePart")
end

local function playSound(id, parent)
    local s = Instance.new("Sound", parent)
    s.SoundId = "rbxassetid://"..id
    s.Volume = 1
    s:Play()
    Debris:AddItem(s, 3)
end

local function showTextAbove(char, text, color, duration)
    local gui = Instance.new("BillboardGui")
    gui.Size = UDim2.new(0, 200, 0, 50)
    gui.Adornee = char:FindFirstChild("HumanoidRootPart")
    gui.StudsOffset = Vector3.new(0, 3, 0)
    gui.AlwaysOnTop = true
    gui.Parent = char

    local label = Instance.new("TextLabel", gui)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = color
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold

    task.delay(duration, function() gui:Destroy() end)
end

local function getFurthestSafePosition()
    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local maxDist = 0
    local bestPos = hrp.Position

    for x = -150, 150, 15 do
        for z = -150, 150, 15 do
            local testPos = hrp.Position + Vector3.new(x, 0, z)
            local dist = (testPos - hrp.Position).Magnitude
            if dist > maxDist and isSafePosition(testPos) then
                maxDist = dist
                bestPos = testPos
            end
        end
    end
    return bestPos
end

local function teleportTo(pos)
    local hrp = getCharacter():FindFirstChild("HumanoidRootPart")
    if hrp and isSafePosition(pos) then
        hrp.CFrame = CFrame.new(pos)
    end
end

local function teleportBehindPlayer(target)
    local now = tick()
    if now - LastTeleportTime < 2.3 then return end
    LastTeleportTime = now

    local targetHRP = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end

    local backVec = -targetHRP.CFrame.LookVector.Unit * 45
    local behindPos = targetHRP.Position + backVec

    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")

    if isSafePosition(behindPos) then
        teleportTo(behindPos)
    else
        teleportTo(getFurthestSafePosition())
    end

    playSound("12222242", hrp) -- poof sound
    showTextAbove(char, "Poof", Color3.new(1, 1, 1), 1)
end

local function startSelfDestruct()
    if not CanSelfDestruct then return end
    CanSelfDestruct = false -- prevent overlapping

    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local originalPos = hrp.Position

    showTextAbove(char, "Self Destruct", Color3.new(1, 0, 0), 5)

    local endTime = tick() + 5
    while tick() < endTime do
        teleportTo(getFurthestSafePosition())
        task.wait(0.1)
    end

    -- Teleport back to original position
    teleportTo(originalPos)
end

--// UI
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "BehindYaGui"
gui.ResetOnSpawn = false

local button = Instance.new("TextButton", gui)
button.Size = UDim2.new(0, 160, 0, 40)
button.Position = UDim2.new(0, 10, 0, 10)
button.Text = "Behind Ya (OFF)"
button.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
button.TextColor3 = Color3.new(1, 1, 1)
button.Font = Enum.Font.GothamBold
button.TextSize = 16

local enabled = false

button.MouseButton1Click:Connect(function()
    enabled = not enabled
    button.Text = "Behind Ya ("..(enabled and "ON" or "OFF")..")"
    button.BackgroundColor3 = enabled and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(0, 0, 255)
end)

--// Respawn tracker
LocalPlayer.CharacterAdded:Connect(function()
    Character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    SpawnTime = tick()
    CanSelfDestruct = false
    task.delay(RespawnCooldown, function()
        CanSelfDestruct = true
    end)
end)

--// Start cooldown on join
task.delay(RespawnCooldown, function()
    CanSelfDestruct = true
end)

--// Main logic
RunService.Heartbeat:Connect(function()
    if not enabled then return end

    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local nearest, dist = nil, math.huge
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local d = (plr.Character.HumanoidRootPart.Position - hrp.Position).Magnitude
            if d < dist then
                dist = d
                nearest = plr
            end
        end
    end

    if nearest and dist < 85 then
        teleportBehindPlayer(nearest)
        task.wait(0.1)
        local newDist = (nearest.Character.HumanoidRootPart.Position - hrp.Position).Magnitude
        if newDist < 10 and CanSelfDestruct then
            startSelfDestruct()
        end
    end
end)
