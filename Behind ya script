--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local function getCharacter()
    return LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
end

--// Map Bounds Detection
local function isSafePosition(pos)
    local rayOrigin = pos + Vector3.new(0, 10, 0)
    local rayDir = Vector3.new(0, -100, 0)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {getCharacter()}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

    local rayResult = workspace:Raycast(rayOrigin, rayDir, raycastParams)
    return rayResult and rayResult.Instance and rayResult.Instance:IsA("BasePart")
end

--// UI
local ScreenGui = Instance.new("ScreenGui", game.CoreGui)
ScreenGui.Name = "BehindYaGUI"
ScreenGui.ResetOnSpawn = false

local Button = Instance.new("TextButton", ScreenGui)
Button.Size = UDim2.new(0, 160, 0, 40)
Button.Position = UDim2.new(0, 10, 0, 10)
Button.Text = "Behind Ya (OFF)"
Button.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
Button.TextColor3 = Color3.new(1, 1, 1)
Button.Font = Enum.Font.GothamBold
Button.TextSize = 16

--// Effects
local function showTextAbove(char, txt, color, duration)
    local bill = Instance.new("BillboardGui", char)
    bill.Size = UDim2.new(0, 200, 0, 50)
    bill.Adornee = char:WaitForChild("HumanoidRootPart")
    bill.StudsOffset = Vector3.new(0, 3, 0)
    bill.AlwaysOnTop = true

    local label = Instance.new("TextLabel", bill)
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = txt
    label.TextColor3 = color
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold

    task.delay(duration, function()
        bill:Destroy()
    end)
end

--// Sounds
local function playSound(id, parent)
    local s = Instance.new("Sound", parent)
    s.SoundId = "rbxassetid://"..id
    s.Volume = 1
    s:Play()
    game.Debris:AddItem(s, 3)
end

--// Teleport Functions
local function teleportTo(pos)
    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp and isSafePosition(pos) then
        hrp.CFrame = CFrame.new(pos)
    end
end

local function getFurthestSafePosition()
    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local maxDist = 0
    local bestPos = hrp.Position

    for x = -150, 150, 15 do
        for z = -150, 150, 15 do
            local testPos = hrp.Position + Vector3.new(x, 0, z)
            local dist = (testPos - hrp.Position).Magnitude
            if dist > maxDist and isSafePosition(testPos) then
                maxDist = dist
                bestPos = testPos
            end
        end
    end
    return bestPos
end

local lastTeleportTime = 0

local function teleportBehindPlayer(target)
    local now = tick()
    if now - lastTeleportTime < 2.3 then return end
    lastTeleportTime = now

    local targetHRP = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end

    local backVec = -targetHRP.CFrame.LookVector.Unit * 45
    local behindPos = targetHRP.Position + backVec
    if isSafePosition(behindPos) then
        teleportTo(behindPos)
    else
        teleportTo(getFurthestSafePosition())
    end

    playSound("12222242", targetHRP) -- poof sound
    showTextAbove(getCharacter(), "Poof", Color3.fromRGB(255, 255, 255), 1)
end

local function startSelfDestruct()
    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    showTextAbove(char, "Self Destruct", Color3.new(1, 0, 0), 5)

    local endTime = tick() + 5
    while tick() < endTime do
        teleportTo(getFurthestSafePosition())
        wait(0.1)
    end

    local middle = workspace:GetCenter() or Vector3.new(0, 100, 0)
    for i = 1, 15 do
        local offset = (i % 2 == 0) and Vector3.new(0, 30, 0) or Vector3.new(0, -30, 0)
        teleportTo(middle + offset)
        wait(0.35)
    end
end

--// Toggle & Logic
local enabled = false
Button.MouseButton1Click:Connect(function()
    enabled = not enabled
    Button.Text = "Behind Ya ("..(enabled and "ON" or "OFF")..")"
    Button.BackgroundColor3 = enabled and Color3.fromRGB(255, 255, 0) or Color3.fromRGB(0, 0, 255)
end)

RunService.Heartbeat:Connect(function()
    if not enabled then return end
    local char = getCharacter()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local closestPlayer, dist = nil, math.huge
    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
            local targetHRP = plr.Character.HumanoidRootPart
            local d = (targetHRP.Position - hrp.Position).Magnitude
            if d < dist then
                closestPlayer, dist = plr, d
            end
        end
    end

    if closestPlayer and dist < 85 then
        teleportBehindPlayer(closestPlayer)
        wait(0.1)
        local stillClose = (closestPlayer.Character.HumanoidRootPart.Position - hrp.Position).Magnitude < 10
        if stillClose then
            startSelfDestruct()
        end
    end
end)
