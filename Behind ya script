--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local Debris = game:GetService("Debris")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--// Variables
local behindYaActive = false
local selfDestructActive = false
local circleLoopActive = false
local cooldownTeleport = false
local cooldownSelfDestruct = false
local lastSafePosition = nil
local viewingPlayer = nil

--// Sounds
local teleportSound = Instance.new("Sound", game.SoundService)
teleportSound.SoundId = "rbxassetid://9118823102"
teleportSound.Volume = 2

local bypassSound = Instance.new("Sound", game.SoundService)
bypassSound.SoundId = "rbxassetid://7489482123"
bypassSound.Volume = 2

--// Helper functions
local function getCharacter(plr)
	return plr.Character or plr.CharacterAdded:Wait()
end

local function getHRP(plr)
	return getCharacter(plr):WaitForChild("HumanoidRootPart", 5)
end

local function showFloatingText(text, color, duration)
	local char = getCharacter(LocalPlayer)
	local hrp = getHRP(LocalPlayer)
	if not char or not hrp then return end
	
	local billboard = Instance.new("BillboardGui")
	billboard.Size = UDim2.new(0, 200, 0, 50)
	billboard.Adornee = hrp
	billboard.StudsOffset = Vector3.new(0, 3, 0)
	billboard.AlwaysOnTop = true
	billboard.Parent = char

	local label = Instance.new("TextLabel", billboard)
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = text
	label.TextColor3 = color
	label.TextScaled = true
	label.Font = Enum.Font.SourceSansBold

	Debris:AddItem(billboard, duration or 2)
end

local function isPositionSafe(pos)
	local size = workspace:GetExtentsSize() / 2 - Vector3.new(5, 0, 5)
	if math.abs(pos.X) > size.X or math.abs(pos.Z) > size.Z then
		return false
	end
	local region = Region3.new(pos - Vector3.new(2, 3, 2), pos + Vector3.new(2, 3, 2))
	local parts = workspace:FindPartsInRegion3(region, nil, 5)
	for _, p in pairs(parts) do
		if p.CanCollide and p.Transparency < 0.95 then
			return false
		end
	end
	return true
end

local function getFurthestSafePosition()
	local hrp = getHRP(LocalPlayer)
	local bestPos = hrp.Position
	local maxDist = 0
	for _, part in pairs(workspace:GetDescendants()) do
		if part:IsA("BasePart") and part.CanCollide then
			local pos = part.Position + Vector3.new(0, 5, 0)
			if isPositionSafe(pos) then
				local dist = (pos - hrp.Position).Magnitude
				if dist > maxDist then
					maxDist = dist
					bestPos = pos
				end
			end
		end
	end
	return bestPos
end

local function playTeleportEffect(hrp)
	-- Yellow sparkle particles
	local particle = Instance.new("ParticleEmitter")
	particle.Color = ColorSequence.new(Color3.fromRGB(255, 255, 100))
	particle.LightEmission = 0.7
	particle.Size = NumberSequence.new(0.5)
	particle.Texture = "rbxassetid://258128463"
	particle.Rate = 80
	particle.Speed = NumberRange.new(1, 3)
	particle.Lifetime = NumberRange.new(0.3, 0.5)
	particle.Parent = hrp
	Debris:AddItem(particle, 0.6)
	
	teleportSound:Play()
end

local function teleportSmoothlyTo(pos)
	local hrp = getHRP(LocalPlayer)
	if not hrp then return end
	
	local offset = Vector3.new(
		math.random(-10,10)/10,
		math.random(-5,5)/10,
		math.random(-10,10)/10
	)
	local targetPos = pos + offset
	
	playTeleportEffect(hrp)

	local tweenInfo = TweenInfo.new(0.15, Enum.EasingStyle.Linear)
	local tween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos)})
	tween:Play()
	tween.Completed:Wait()

	task.wait(math.random(10, 20) / 100) -- random delay for anti-cheat bypass
end

local function getNearestPlayer(radius)
	local hrp = getHRP(LocalPlayer)
	local nearestPlayer = nil
	local nearestDistance = radius + 1
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (plr.Character.HumanoidRootPart.Position - hrp.Position).Magnitude
			if dist < nearestDistance then
				nearestDistance = dist
				nearestPlayer = plr
			end
		end
	end
	return nearestPlayer, nearestDistance
end

local function teleportBehindPlayer(target)
	if not target or not target.Character then return end
	local hrp = getHRP(LocalPlayer)
	local targetHRP = getHRP(target)
	if not hrp or not targetHRP then return end

	local lookVector = targetHRP.CFrame.LookVector
	local desiredPos = targetHRP.Position - lookVector * 45

	if not isPositionSafe(desiredPos) then
		desiredPos = getFurthestSafePosition()
	end

	teleportSmoothlyTo(desiredPos)
	showFloatingText("Poof!", Color3.fromRGB(255, 255, 100), 1)
end

--// GUI Setup
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BehindYaGui"
ScreenGui.Parent = game.CoreGui

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 180, 0, 250)
mainFrame.Position = UDim2.new(0, 20, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
mainFrame.BorderColor3 = Color3.fromRGB(255, 140, 0)
mainFrame.Parent = ScreenGui
mainFrame.Active = true
mainFrame.Draggable = true

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 0, 35)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Behind Ya Script"
titleLabel.TextColor3 = Color3.fromRGB(255, 140, 0)
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.TextScaled = true
titleLabel.Parent = mainFrame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, -20, 0, 40)
toggleBtn.Position = UDim2.new(0, 10, 0, 50)
toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 140, 0)
toggleBtn.TextColor3 = Color3.new(0,0,0)
toggleBtn.Font = Enum.Font.SourceSansBold
toggleBtn.TextScaled = true
toggleBtn.Text = "Activate Behind Ya"
toggleBtn.Parent = mainFrame

local selfDestructBtn = Instance.new("TextButton")
selfDestructBtn.Size = UDim2.new(1, -20, 0, 40)
selfDestructBtn.Position = UDim2.new(0, 10, 0, 100)
selfDestructBtn.BackgroundColor3 = Color3.fromRGB(200, 30, 30)
selfDestructBtn.TextColor3 = Color3.new(1,1,1)
selfDestructBtn.Font = Enum.Font.SourceSansBold
selfDestructBtn.TextScaled = true
selfDestructBtn.Text = "Toggle Self Destruct"
selfDestructBtn.Parent = mainFrame

local circleLoopBtn = Instance.new("TextButton")
circleLoopBtn.Size = UDim2.new(1, -20, 0, 40)
circleLoopBtn.Position = UDim2.new(0, 10, 0, 150)
circleLoopBtn.BackgroundColor3 = Color3.fromRGB(255, 180, 0)
circleLoopBtn.TextColor3 = Color3.new(0,0,0)
circleLoopBtn.Font = Enum.Font.SourceSansBold
circleLoopBtn.TextScaled = true
circleLoopBtn.Text = "Toggle Circle Loop"
circleLoopBtn.Parent = mainFrame

local viewPlayerBtn = Instance.new("TextButton")
viewPlayerBtn.Size = UDim2.new(1, -20, 0, 40)
viewPlayerBtn.Position = UDim2.new(0, 10, 0, 200)
viewPlayerBtn.BackgroundColor3 = Color3.fromRGB(70, 130, 180)
viewPlayerBtn.TextColor3 = Color3.new(1,1,1)
viewPlayerBtn.Font = Enum.Font.SourceSansBold
viewPlayerBtn.TextScaled = true
viewPlayerBtn.Text = "View Player"
viewPlayerBtn.Parent = mainFrame

--// Behind Ya toggle logic
toggleBtn.MouseButton1Click:Connect(function()
	behindYaActive = not behindYaActive
	if behindYaActive then
		toggleBtn.Text = "Deactivate Behind Ya"
		lastSafePosition = getHRP(LocalPlayer).Position
		showFloatingText("Behind Ya Activated!", Color3.fromRGB(255, 140, 0), 2)
	else
		toggleBtn.Text = "Activate Behind Ya"
		showFloatingText("Behind Ya Deactivated!", Color3.fromRGB(255, 140, 0), 2)
	end
end)

--// Self Destruct toggle
selfDestructBtn.MouseButton1Click:Connect(function()
	selfDestructActive = not selfDestructActive
	if selfDestructActive then
		selfDestructBtn.Text = "Self Destruct: ON"
		showFloatingText("Self Destruct Activated", Color3.fromRGB(200, 30, 30), 2)
	else
		selfDestructBtn.Text = "Self Destruct: OFF"
		showFloatingText("Self Destruct Deactivated", Color3.fromRGB(255, 255, 255), 2)
	end
end)

--// Circle Loop toggle
circleLoopBtn.MouseButton1Click:Connect(function()
	if circleLoopActive then
		circleLoopActive = false
		circleLoopBtn.Text = "Toggle Circle Loop"
	else
		circleLoopActive = true
		circleLoopBtn.Text = "Circle Loop: ON"
		coroutine.wrap(function()
			local hrp = getHRP(LocalPlayer)
			local center = hrp.Position
			local radius = 50
			local angle = 0
			while circleLoopActive do
				if not behindYaActive then break end
				local x = center.X + math.cos(angle) * radius
				local z = center.Z + math.sin(angle) * radius
				local newPos = Vector3.new(x, center.Y, z)
				if isPositionSafe(newPos) then
					teleportSmoothlyTo(newPos)
				end
				angle = angle + math.rad(30)
				task.wait(0.12 + math.random(5, 15) / 100)
			end
			circleLoopBtn.Text = "Toggle Circle Loop"
		end)()
	end
end)

--// View Player button
viewPlayerBtn.MouseButton1Click:Connect(function()
	local plrs = Players:GetPlayers()
	local names = {}
	for _, p in pairs(plrs) do
		if p ~= LocalPlayer then
			table.insert(names, p.Name)
		end
	end
	if #names == 0 then
		showFloatingText("No other players!", Color3.new(1,0,0), 2)
		return
	end

	local choice = names[math.random(1, #names)]
	local plr = Players:FindFirstChild(choice)
	if plr and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
		viewingPlayer = plr
		Camera.CameraSubject = plr.Character.Humanoid
		showFloatingText("Viewing " .. choice, Color3.fromRGB(70, 130, 180), 2)
	end
end)

--// Reset camera to self when player leaves or presses toggle again
Players.PlayerRemoving:Connect(function(plr)
	if plr == viewingPlayer then
		Camera.CameraSubject = getCharacter(LocalPlayer).Humanoid
		viewingPlayer = nil
	end
end)

--// Auto reset camera when Behind Ya toggled off
RunService.Heartbeat:Connect(function()
	if not behindYaActive and viewingPlayer then
		Camera.CameraSubject = getCharacter(LocalPlayer).Humanoid
		viewingPlayer = nil
	end
end)

--// Main Behind Ya logic loop
RunService.Heartbeat:Connect(function()
	if behindYaActive and not cooldownTeleport and not selfDestructActive then
		local target, dist = getNearestPlayer(85)
		local hrp = getHRP(LocalPlayer)
		if not hrp then return end

		-- Auto self destruct if player too close
		if dist and dist <= 35 then
			selfDestructActive = true
			selfDestructBtn.Text = "Self Destruct: ON"
			showFloatingText("Self Destruct Activated", Color3.fromRGB(200, 30, 30), 2)
		end

		if target and dist and dist <= 85 then
			teleportBehindPlayer(target)
			lastSafePosition = hrp.Position
			cooldownTeleport = true
			task.delay(2.3, function() cooldownTeleport = false end)
		end

		-- Stuck detection and auto teleport back
		if lastSafePosition then
			local pos = hrp.Position
			if pos.Y < 0 or (pos - lastSafePosition).Magnitude > 55 then
				teleportSmoothlyTo(lastSafePosition)
				showFloatingText("Bypassed Anti Cheat!", Color3.fromRGB(0, 255, 0), 3)
				bypassSound:Play()
				task.wait(0.3)
			end
		end
	end
end)
