--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local SoundService = game:GetService("SoundService")

-- Utility functions
local function getCharacter(plr)
	return plr.Character or plr.CharacterAdded:Wait()
end

local function getHRP(plr)
	local char = getCharacter(plr)
	return char and char:FindFirstChild("HumanoidRootPart")
end

local function safeCFrame(pos)
	local size = Workspace:GetExtentsSize() / 2 - Vector3.new(5, 0, 5)
	if math.abs(pos.X) > size.X or math.abs(pos.Z) > size.Z then
		return false
	end
	local region = Region3.new(pos - Vector3.new(2, 3, 2), pos + Vector3.new(2, 3, 2))
	local parts = Workspace:FindPartsInRegion3(region, nil, 5)
	for _, p in pairs(parts) do
		if p.CanCollide and p.Transparency < 0.95 then return true end
	end
	return false
end

local function getFurthest()
	local root = getHRP(LocalPlayer)
	if not root then return Vector3.new(0,10,0) end
	local best = root.Position
	local maxDist = 0
	for _, part in pairs(Workspace:GetDescendants()) do
		if part:IsA("BasePart") then
			local pos = part.Position + Vector3.new(0, 5, 0)
			if safeCFrame(pos) then
				local dist = (pos - root.Position).Magnitude
				if dist > maxDist then
					maxDist = dist
					best = pos
				end
			end
		end
	end
	return best
end

-- GUI Setup
local gui = Instance.new("ScreenGui", game.CoreGui)
gui.Name = "BehindYaUI"

local toggleBtn = Instance.new("TextButton", gui)
toggleBtn.Size = UDim2.new(0, 150, 0, 35)
toggleBtn.Position = UDim2.new(0, 10, 0, 10)
toggleBtn.Text = "Behind Ya: OFF"
toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.AutoButtonColor = false

local selfDestructBtn = Instance.new("TextButton", gui)
selfDestructBtn.Size = UDim2.new(0, 150, 0, 30)
selfDestructBtn.Position = UDim2.new(0, 10, 0, 50)
selfDestructBtn.Text = "Start Self-Destruct"
selfDestructBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
selfDestructBtn.TextColor3 = Color3.new(1, 1, 1)

local circleLoopBtn = Instance.new("TextButton", gui)
circleLoopBtn.Size = UDim2.new(0, 150, 0, 30)
circleLoopBtn.Position = UDim2.new(0, 10, 0, 90)
circleLoopBtn.Text = "Enable Circle Loop"
circleLoopBtn.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
circleLoopBtn.TextColor3 = Color3.new(1, 1, 1)

local viewBtn = Instance.new("TextButton", gui)
viewBtn.Size = UDim2.new(0, 130, 0, 30)
viewBtn.Position = UDim2.new(0, 10, 0, 130)
viewBtn.Text = "üëÅ View Player"
viewBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
viewBtn.TextColor3 = Color3.new(1, 1, 1)

local unviewBtn = Instance.new("TextButton", gui)
unviewBtn.Size = UDim2.new(0, 130, 0, 30)
unviewBtn.Position = UDim2.new(0, 10, 0, 170)
unviewBtn.Text = "üíô Unview Self"
unviewBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
unviewBtn.TextColor3 = Color3.new(1, 1, 1)

local musicBtn = Instance.new("TextButton", gui)
musicBtn.Size = UDim2.new(0, 150, 0, 30)
musicBtn.Position = UDim2.new(0, 10, 0, 210)
musicBtn.Text = "Music Player"
musicBtn.BackgroundColor3 = Color3.fromRGB(150, 150, 255)
musicBtn.TextColor3 = Color3.new(1, 1, 1)

local hideGuiBtn = Instance.new("TextButton", gui)
hideGuiBtn.Size = UDim2.new(0, 150, 0, 30)
hideGuiBtn.Position = UDim2.new(0, 10, 0, 250)
hideGuiBtn.Text = "Hide GUI"
hideGuiBtn.BackgroundColor3 = Color3.fromRGB(180, 180, 180)
hideGuiBtn.TextColor3 = Color3.new(0, 0, 0)

-- Sounds
local teleportSound = Instance.new("Sound", SoundService)
teleportSound.SoundId = "rbxassetid://9118823102" -- teleport sound
teleportSound.Volume = 2

local speedSound = Instance.new("Sound", SoundService)
speedSound.SoundId = "rbxassetid://9118829390" -- speed coil sound
speedSound.Volume = 1

-- Music player setup
local musicGui = Instance.new("Frame")
musicGui.Size = UDim2.new(0, 200, 0, 160)
musicGui.Position = UDim2.new(0, 170, 0, 210)
musicGui.BackgroundColor3 = Color3.fromRGB(40, 40, 70)
musicGui.Visible = false
musicGui.Parent = gui

local musicTitle = Instance.new("TextLabel", musicGui)
musicTitle.Size = UDim2.new(1, 0, 0, 25)
musicTitle.BackgroundTransparency = 1
musicTitle.Text = "Select Music:"
musicTitle.TextColor3 = Color3.new(1, 1, 1)
musicTitle.Font = Enum.Font.SourceSansBold
musicTitle.TextScaled = true

local musicTracks = {
	{ name = "Epic Adventure", id = "1845719977" },
	{ name = "Calm Night", id = "9118829390" },
	{ name = "Battle Theme", id = "12222145" },
	{ name = "Chill Vibes", id = "1838595270" },
}

local musicButtons = {}

for i, track in ipairs(musicTracks) do
	local btn = Instance.new("TextButton", musicGui)
	btn.Size = UDim2.new(1, -20, 0, 30)
	btn.Position = UDim2.new(0, 10, 0, 25 + (i-1)*35)
	btn.Text = track.name
	btn.BackgroundColor3 = Color3.fromRGB(80, 80, 120)
	btn.TextColor3 = Color3.new(1, 1, 1)
	btn.AutoButtonColor = true
	btn.Font = Enum.Font.SourceSansBold
	btn.TextScaled = true
	btn.Name = "MusicButton_"..i
	musicButtons[i] = btn
end

local musicPlaying = Instance.new("Sound", SoundService)
musicPlaying.Volume = 0.8
musicPlaying.Looped = true

local function playMusic(id)
	musicPlaying.SoundId = "rbxassetid://" .. id
	musicPlaying:Play()
end

local function stopMusic()
	musicPlaying:Stop()
end

-- Text display function
local function showText(msg, color, duration)
	local textLabel = Instance.new("TextLabel", gui)
	textLabel.Text = msg
	textLabel.TextColor3 = color or Color3.new(1,1,1)
	textLabel.BackgroundTransparency = 0.5
	textLabel.BackgroundColor3 = Color3.new(0,0,0)
	textLabel.Size = UDim2.new(0, 250, 0, 30)
	textLabel.Position = UDim2.new(0.5, -125, 1, -40)
	textLabel.TextScaled = true
	textLabel.Font = Enum.Font.SourceSansBold
	task.delay(duration or 3, function()
		if textLabel then
			textLabel:Destroy()
		end
	end)
	return textLabel
end

-- Cooldowns and flags
local cooldowns = {
	circleLoop = false,
}
local selfDestructActive = false
local circleLoopActive = false

-- Teleport helper
local function teleportWithChecks(pos)
	if not pos then return end
	local hrp = getHRP(LocalPlayer)
	if not hrp then return end
	
	teleportSound:Play()
	hrp.CFrame = CFrame.new(pos)
end

local function isStuck()
	local hrp = getHRP(LocalPlayer)
	if not hrp then return false end
	local ray = Ray.new(hrp.Position, Vector3.new(0, -4, 0))
	local part = Workspace:FindPartOnRay(ray, LocalPlayer.Character)
	return part == nil
end

local function autoTeleportOut()
	local pos = getFurthest()
	teleportWithChecks(pos)
	showText("Successfully bypassed anti cheat", Color3.fromRGB(0, 255, 0), 3)
end

-- Self-destruct loop
local function selfDestructLoop()
	if selfDestructActive then return end
	selfDestructActive = true
	selfDestructBtn.Text = "Stop Self-Destruct"
	selfDestructBtn.BackgroundColor3 = Color3.fromRGB(255, 50, 50)

	while selfDestructActive do
		local root = getHRP(LocalPlayer)
		if not root then break end
		local pos = root.Position

		local closestDist = math.huge
		for _, plr in pairs(Players:GetPlayers()) do
			if plr ~= LocalPlayer then
				local targetHRP = getHRP(plr)
				if targetHRP then
					local dist = (targetHRP.Position - pos).Magnitude
					if dist < closestDist then
						closestDist = dist
					end
				end
			end
		end

		if closestDist <= 35 then
			local furthestPos = getFurthest()
			teleportWithChecks(furthestPos)
			task.wait(0.3)
		else
			task.wait(0.5)
		end
	end
	selfDestructBtn.Text = "Start Self-Destruct"
	selfDestructBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
end

-- Stop self destruct
local function stopSelfDestruct()
	selfDestructActive = false
	selfDestructBtn.Text = "Start Self-Destruct"
	selfDestructBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 100)
end

-- Circle loop: teleport in circle on map with WalkSpeed 45 and wait ~0.02 (3x faster than 0.06)
local function circleLoop()
	local root = getHRP(LocalPlayer)
	if not root then return end
	local centerPos = root.Position
	local radius = 195
	local humanoid = getCharacter(LocalPlayer):FindFirstChildOfClass("Humanoid")
	if not humanoid then return end

	local originalSpeed = humanoid.WalkSpeed
	humanoid.WalkSpeed = 45
	speedSound:Play()

	for deg = 0, 360, 5 do -- finer steps for smooth circle
		if not circleLoopActive then break end
		local rad = math.rad(deg)
		local x = centerPos.X + math.cos(rad) * radius
		local z = centerPos.Z + math.sin(rad) * radius
		local y = centerPos.Y
		local pos = Vector3.new(x, y, z)

		if safeCFrame(pos) then
			teleportWithChecks(pos)
		else
			-- Try smaller radius
			local tries = 0
			local maxTries = 10
			local newRadius = radius
			local safePos = nil
			while tries < maxTries do
				newRadius = newRadius - 10
				if newRadius <= 10 then break end
				x = centerPos.X + math.cos(rad) * newRadius
				z = centerPos.Z + math.sin(rad) * newRadius
				pos = Vector3.new(x, y, z)
				if safeCFrame(pos) then
					safePos = pos
					break
				end
				tries = tries + 1
			end
			if safePos then
				teleportWithChecks(safePos)
			end
		end
		task.wait(0.02) -- 3x faster speed
	end
	humanoid.WalkSpeed = originalSpeed
end

-- Main loop
local function mainLoop()
	while isActive do
		local hrp = getHRP(LocalPlayer)
		if not hrp then break end
		local pos = hrp.Position

		if isStuck() then
			autoTeleportOut()
		end

		local nearestDist = math.huge
		local nearestPlayer = nil
		local playersIn195 = {}

		for _, plr in pairs(Players:GetPlayers()) do
			if plr ~= LocalPlayer then
				local targetHRP = getHRP(plr)
				if targetHRP then
					local dist = (targetHRP.Position - pos).Magnitude
					if dist <= 35 then
						-- Self-destruct triggers automatically
						if not selfDestructActive then
							task.spawn(selfDestructLoop)
						end
					elseif dist <= 85 then
						if dist < nearestDist then
							nearestDist = dist
							nearestPlayer = plr
						end
					elseif dist <= 195 then
						table.insert(playersIn195, plr)
					end
				end
			end
		end

		if nearestPlayer then
			teleportBehindPlayer(nearestPlayer)
		end

		if circleLoopActive and #playersIn195 > 0 then
			circleLoop()
		end

		task.wait(0.15)
	end
end

-- Teleport behind player helper
function teleportBehindPlayer(player)
	local hrp = getHRP(LocalPlayer)
	local targetHRP = getHRP(player)
	if not hrp or not targetHRP then return end

	local backOffset = -5
	local targetPos = targetHRP.CFrame * CFrame.new(0, 0, backOffset)
	if safeCFrame(targetPos.Position) then
		teleportWithChecks(targetPos.Position)
	end
end

-- Button events

toggleBtn.MouseButton1Click:Connect(function()
	isActive = not isActive
	if isActive then
		toggleBtn.Text = "Behind Ya: ON"
		toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
		task.spawn(mainLoop)
	else
		toggleBtn.Text = "Behind Ya: OFF"
		toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 0, 255)
		stopSelfDestruct()
		circleLoopActive = false
		circleLoopBtn.Text = "Enable Circle Loop"
		circleLoopBtn.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
	end
end)

selfDestructBtn.MouseButton1Click:Connect(function()
	if selfDestructActive then
		stopSelfDestruct()
	else
		task.spawn(selfDestructLoop)
	end
end)

-- Circle Loop toggle with cooldown
circleLoopBtn.MouseButton1Click:Connect(function()
	if cooldowns.circleLoop then
		showText("Circle Loop cooldown! Wait 5 seconds.", Color3.fromRGB(1,0,0), 2)
		return
	end

	circleLoopActive = not circleLoopActive
	if circleLoopActive then
		circleLoopBtn.Text = "Disable Circle Loop"
		circleLoopBtn.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
		cooldowns.circleLoop = true
		task.delay(5, function()
			cooldowns.circleLoop = false
		end)
	else
		circleLoopBtn.Text = "Enable Circle Loop"
		circleLoopBtn.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
	end
end)

viewBtn.MouseButton1Click:Connect(function()
	local playersList = {}
	for _, plr in pairs(Players:GetPlayers()) do
		if plr ~= LocalPlayer then
			table.insert(playersList, plr)
		end
	end
	if #playersList == 0 then
		showText("No other players found", Color3.new(1, 1, 0), 3)
		return
	end
	local currentIdx = 1
	local function cycle()
		if currentIdx > #playersList then currentIdx = 1 end
		local plr = playersList[currentIdx]
		local char = getCharacter(plr)
		if char then
			local hum = char:FindFirstChildOfClass("Humanoid")
			if hum then
				Camera.CameraSubject = hum
				showText("Viewing: "..plr.Name, Color3.new(0, 1, 1), 3)
			end
		end
		currentIdx = currentIdx + 1
	end
	cycle()
end)

unviewBtn.MouseButton1Click:Connect(function()
	local char = getCharacter(LocalPlayer)
	if char then
		local hum = char:FindFirstChildOfClass("Humanoid")
		if hum then
			Camera.CameraSubject = hum
			showText("Viewing self", Color3.new(0, 1, 1), 3)
		end
	end
end)

-- Hide/show GUI
local guiVisible = true
hideGuiBtn.MouseButton1Click:Connect(function()
	guiVisible = not guiVisible
	selfDestructBtn.Visible = guiVisible
	circleLoopBtn.Visible = guiVisible
	viewBtn.Visible = guiVisible
	unviewBtn.Visible = guiVisible
	musicBtn.Visible = guiVisible
end)

-- Music player button opens/closes music UI
musicBtn.MouseButton1Click:Connect(function()
	musicGui.Visible = not musicGui.Visible
end)

-- Music buttons
for i, btn in ipairs(musicButtons) do
	btn.MouseButton1Click:Connect(function()
		local track = musicTracks[i]
		if track then
			playMusic(track.id)
			showText("Playing: "..track.name, Color3.new(0,1,0), 3)
		end
	end)
end

print("Behind Ya script loaded! Controls ready.")
